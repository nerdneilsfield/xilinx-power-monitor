name: Build RPM Package for ZynqMP

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

jobs:
  build_zynqmp_rpm:
    name: Build RPM for PetaLinux ZynqMP (ARM64)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install cross-compilation toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            cmake \
            rpm \
            file \
            wget

          # Verify toolchain installation
          which aarch64-linux-gnu-gcc
          which aarch64-linux-gnu-g++
          aarch64-linux-gnu-gcc --version
          aarch64-linux-gnu-g++ --version

      - name: Setup ARM64 sysroot with ncurses 6.2
        run: |
          set -e

          # Create sysroot directory
          mkdir -p $HOME/aarch64-sysroot/usr/{include,lib}

          # Download and build ncurses 6.2 for ARM64
          cd $HOME
          wget https://ftp.gnu.org/gnu/ncurses/ncurses-6.2.tar.gz
          tar xzf ncurses-6.2.tar.gz
          cd ncurses-6.2

          # Configure for ARM64 cross-compilation
          ./configure \
            --host=aarch64-linux-gnu \
            --prefix=/usr \
            --with-shared \
            --enable-widec \
            --with-termlib \
            --without-debug \
            --without-tests \
            --without-progs

          make -j$(nproc)

          # Manually copy headers and libraries to sysroot (skip progs to avoid strip issue)
          echo "Copying ncurses headers and libraries to sysroot..."

          # Copy headers - ncurses generates headers in include/ directory
          echo "Available headers:"
          ls -la include/*.h

          # Copy all generated headers
          cp include/*.h $HOME/aarch64-sysroot/usr/include/ 2>/dev/null || true

          # Also check if there's a subdirectory
          if [ -d "include/ncurses" ]; then
            mkdir -p $HOME/aarch64-sysroot/usr/include/ncurses
            cp include/ncurses/*.h $HOME/aarch64-sysroot/usr/include/ncurses/ 2>/dev/null || true
          fi

          # Create ncurses.h symlink (ncurses expects this)
          cd $HOME/aarch64-sysroot/usr/include
          ln -sf curses.h ncurses.h

          # Verify headers were copied
          echo "Headers in sysroot:"
          ls -la $HOME/aarch64-sysroot/usr/include/ | grep -E '(curses|ncurses|term)' || echo "Warning: No ncurses headers found"

          # Copy libraries
          echo "Available libraries:"
          ls -la lib/

          cp -P lib/libncurses*.so* $HOME/aarch64-sysroot/usr/lib/ || true
          cp -P lib/libncurses*.a $HOME/aarch64-sysroot/usr/lib/ || true
          cp -P lib/libtinfo*.so* $HOME/aarch64-sysroot/usr/lib/ || true
          cp -P lib/libtinfo*.a $HOME/aarch64-sysroot/usr/lib/ || true

          # Create symlinks for non-wide version
          cd $HOME/aarch64-sysroot/usr/lib
          ln -sf libncursesw.so libncurses.so || true
          ln -sf libncursesw.a libncurses.a || true
          ln -sf libtinfow.so libtinfo.so || true
          ln -sf libtinfow.a libtinfo.a || true

          # Verify libraries
          echo "Built libraries in sysroot:"
          ls -lh $HOME/aarch64-sysroot/usr/lib/libncurses* $HOME/aarch64-sysroot/usr/lib/libtinfo* || true
          file $HOME/aarch64-sysroot/usr/lib/libncurses*.so* || true

          echo "ARM64 sysroot with ncurses 6.2 (with tinfo) created at $HOME/aarch64-sysroot"

      - name: Build for ZynqMP (ARM64 cross-compile)
        run: |
          set -e

          # Set sysroot environment variable for toolchain file
          export ZYNQMP_SYSROOT=$HOME/aarch64-sysroot

          echo "Using ZynqMP sysroot: $ZYNQMP_SYSROOT"
          echo "Toolchain file: ${GITHUB_WORKSPACE}/.github/toolchain-zynqmp.cmake"

          # Create build directory
          rm -rf build_zynqmp
          mkdir -p build_zynqmp
          cd build_zynqmp

          # Configure with ZynqMP toolchain file
          cmake \
            -DCMAKE_TOOLCHAIN_FILE=${GITHUB_WORKSPACE}/.github/toolchain-zynqmp.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCURSES_INCLUDE_PATH=$ZYNQMP_SYSROOT/usr/include \
            -DCURSES_LIBRARY=$ZYNQMP_SYSROOT/usr/lib/libncurses.so \
            -DBUILD_PYTHON_BINDINGS=OFF \
            -DBUILD_CPP_BINDINGS=ON \
            -DBUILD_CLI=ON \
            -DBUILD_TESTS=OFF \
            -DUSE_EIGEN=OFF \
            -DBUILD_EXAMPLES=OFF \
            ..

          # Build
          echo "Building for PetaLinux ZynqMP (ARM64)..."
          make -j$(nproc) VERBOSE=1

          # Verify architecture of built binaries
          echo "Verifying binary architecture..."
          file xilinx-power-ctl/xilinx_power_ctl || true

          # Package as RPM
          cpack -G RPM

      - name: Rename package
        run: |
          cd build_zynqmp
          for pkg in *.rpm; do
            new_name=$(echo $pkg | sed "s/.rpm/_petalinux-zynqmp-aarch64.rpm/")
            mv "$pkg" "$new_name"
            echo "Created package: $new_name"
          done

      - name: Upload RPM package
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package-zynqmp
          path: build_zynqmp/*.rpm
          if-no-files-found: error

  release_package:
    name: Release ZynqMP RPM Package
    needs: build_zynqmp_rpm
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-package-zynqmp
          path: packages

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: packages/*.rpm
